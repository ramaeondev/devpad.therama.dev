<div class="h-full flex flex-col bg-gray-50 dark:bg-gray-900">
  <!-- Header with Back Button -->
  <div class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-6 py-4">
    <div class="flex items-center gap-4">
      <button
        (click)="goBack()"
        class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
        title="Back to Dashboard"
      >
        <i class="fa-solid fa-arrow-left text-xl text-gray-700 dark:text-gray-300"></i>
      </button>
      <div>
        <h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100">Activity Log</h1>
        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
          View your recent activities and device history
        </p>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="flex-1 overflow-auto px-6 py-4">
    @if (loading()) {
      <div class="flex items-center justify-center h-64">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
      </div>
    } @else if (logs().length === 0) {
      <div class="flex flex-col items-center justify-center h-64 text-gray-500 dark:text-gray-400">
        <i class="fa-regular fa-clock-rotate-left text-5xl mb-4"></i>
        <p class="text-lg font-medium">No activity logs found</p>
        <p class="text-sm mt-2">Try adjusting your filters</p>
      </div>
    } @else {
      <!-- Table -->
      <div
        class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 overflow-x-auto"
      >
        <table class="w-full">
          <thead class="bg-gray-50 dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700">
            <tr>
              <th
                class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider"
              >
                Timestamp
              </th>
              <th
                class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider"
              >
                <!-- Action Filter -->
                <select
                  [(ngModel)]="selectedActionType"
                  (ngModelChange)="onFilterChange()"
                  class="text-xs px-2 py-1 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                >
                  @for (type of actionTypes; track type) {
                    <option [value]="type">{{ type === 'all' ? 'All Actions' : type }}</option>
                  }
                </select>
              </th>
              <th
                class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider"
              >
                <!-- Resource Filter -->
                <select
                  [(ngModel)]="selectedResourceType"
                  (ngModelChange)="onFilterChange()"
                  class="text-xs px-2 py-1 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                >
                  @for (type of resourceTypes; track type) {
                    <option [value]="type">{{ type === 'all' ? 'All Resources' : type }}</option>
                  }
                </select>
              </th>
              <th
                class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider"
              >
                Resource Name
              </th>
              <th
                class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider"
              >
                Device
              </th>
              <th
                class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider"
              >
                <!-- Date Filter -->
                <select
                  [(ngModel)]="selectedDateRange"
                  (ngModelChange)="onFilterChange()"
                  class="text-xs px-2 py-1 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                >
                  <option value="all">All Time</option>
                  <option value="today">Today</option>
                  <option value="week">Last 7 Days</option>
                  <option value="month">Last 30 Days</option>
                </select>
              </th>
              <th
                class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider"
              >
                Actions
              </th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
            @for (log of logs(); track log.id) {
              <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
                <!-- Timestamp -->
                <td class="px-4 py-3 text-sm text-gray-900 dark:text-gray-100 whitespace-nowrap">
                  <div class="flex flex-col">
                    <span class="font-medium">{{ formatDate(log.created_at) }}</span>
                    <span class="text-xs text-gray-500">{{ getRelativeTime(log.created_at) }}</span>
                  </div>
                </td>

                <!-- Action -->
                <td class="px-4 py-3 text-sm whitespace-nowrap">
                  <div class="flex items-center gap-2">
                    <i
                      class="fa-solid {{ getActionIcon(log.action_type) }} {{
                        getActionColor(log.action_type)
                      }}"
                    ></i>
                    <span class="capitalize text-gray-900 dark:text-gray-100">{{
                      log.action_type
                    }}</span>
                  </div>
                </td>

                <!-- Resource Type -->
                <td class="px-4 py-3 text-sm whitespace-nowrap">
                  <div class="flex items-center gap-2">
                    <i class="fa-solid {{ getResourceIcon(log.resource_type) }} text-gray-400"></i>
                    <span class="capitalize text-gray-900 dark:text-gray-100">{{
                      log.resource_type
                    }}</span>
                  </div>
                </td>

                <!-- Resource Name -->
                <td class="px-4 py-3 text-sm text-gray-900 dark:text-gray-100">
                  {{ log.resource_name || '-' }}
                </td>

                <!-- Device -->
                <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">
                  @if (log.device_info) {
                    <div class="flex flex-col text-xs">
                      @if (log.device_info.browser_name) {
                        <span>{{ log.device_info.browser_name }}</span>
                      }
                      @if (log.device_info.os_name) {
                        <span>{{ log.device_info.os_name }}</span>
                      }
                    </div>
                  } @else {
                    <span>-</span>
                  }
                </td>

                <!-- Date Range (empty, just for filter) -->
                <td class="px-4 py-3"></td>

                <!-- Actions -->
                <td class="px-4 py-3 text-sm whitespace-nowrap">
                  <div class="flex items-center gap-2">
                    <button
                      (click)="toggleRawJson(log.id)"
                      class="text-blue-600 dark:text-blue-400 hover:underline text-xs"
                      title="View raw JSON"
                    >
                      {{ expandedLogId() === log.id ? 'Hide' : 'View' }} JSON
                    </button>
                    <button
                      (click)="downloadJson(log)"
                      class="text-green-600 dark:text-green-400 hover:underline text-xs"
                      title="Download JSON"
                    >
                      <i class="fa-solid fa-download"></i>
                    </button>
                  </div>
                </td>
              </tr>

              <!-- Expanded Raw JSON Row -->
              @if (expandedLogId() === log.id) {
                <tr>
                  <td colspan="7" class="px-4 py-3 bg-gray-50 dark:bg-gray-900">
                    <div class="text-xs">
                      <div class="flex items-center justify-between mb-2">
                        <span class="font-medium text-gray-700 dark:text-gray-300"
                          >Raw JSON Data</span
                        >
                        <button
                          (click)="copyJson(log)"
                          class="text-blue-600 dark:text-blue-400 hover:underline"
                        >
                          <i class="fa-solid fa-copy"></i> Copy
                        </button>
                      </div>
                      <pre
                        class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded p-3 overflow-x-auto text-gray-900 dark:text-gray-100"
                        >{{ formatJson(log) }}</pre
                      >
                    </div>
                  </td>
                </tr>
              }
            }
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      @if (totalPages() > 1) {
        <div class="flex flex-col sm:flex-row items-center justify-between mt-6 gap-4 sm:gap-0">
          <div class="text-sm text-gray-600 dark:text-gray-400">
            Showing {{ (currentPage() - 1) * pageSize + 1 }} to
            {{ Math.min(currentPage() * pageSize, totalCount()) }} of {{ totalCount() }} results
          </div>
          <div class="flex items-center gap-2">
            <button
              (click)="previousPage()"
              [disabled]="currentPage() === 1"
              class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              Previous
            </button>
            <span class="text-sm text-gray-600 dark:text-gray-400">
              Page {{ currentPage() }} of {{ totalPages() }}
            </span>
            <button
              (click)="nextPage()"
              [disabled]="currentPage() === totalPages()"
              class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              Next
            </button>
          </div>
        </div>
      }
    }
  </div>
</div>
